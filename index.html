<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vida - Via AI</title>
  <style>
    body { font-family: monospace; background: #111; color: #eee; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
    .terminal { flex:1; padding:10px; overflow-y:auto; background:#000; }
    .input-line { display:flex; padding:10px; background:#111; }
    .input-line span { color:#0f0; margin-right:5px; }
    input { flex:1; background:#111; color:#eee; border:none; outline:none; padding:5px; }
    button { background:#0f0; color:#000; border:none; cursor:pointer; padding:5px 10px; }
    .via { color:#0f0; }
    .user { color:#fff; }
    .download-btn { margin-top:5px; background:#0f0; color:#000; border:none; padding:5px 10px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="terminal" id="terminal"></div>
  <div class="input-line">
    <span>&gt;</span>
    <input id="prompt" type="text" placeholder="Ask Via to generate code..." />
    <button id="send">Send</button>
  </div>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Vida App -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function Vida() {
      const [messages, setMessages] = useState(() => {
        const saved = localStorage.getItem("vidaChatHistory");
        return saved ? JSON.parse(saved) : [];
      });
      const [loading, setLoading] = useState(false);
      const [generatedFile, setGeneratedFile] = useState(null);
      const terminalRef = useRef(null);

      useEffect(() => {
        terminalRef.current?.scrollTo({ top: terminalRef.current.scrollHeight, behavior: "smooth" });
        localStorage.setItem("vidaChatHistory", JSON.stringify(messages));
      }, [messages]);

      const sendPrompt = async (prompt) => {
        setMessages(prev => [...prev, { role: "user", content: prompt }]);
        setLoading(true);

        try {
          // Use Netlify environment variable injected at build time
          const HF_KEY = import.meta.env.VITE_HUGGINGFACE_API_KEY;

          const response = await fetch(
            "https://api-inference.huggingface.co/models/deepseek-ai/DeepSeek-R1",
            {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${HF_KEY}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ inputs: prompt }),
            }
          );
          const data = await response.json();
          const fullOutput = data?.generated_text || "// No output";

          let i = 0;
          const interval = setInterval(() => {
            if (i <= fullOutput.length) {
              setMessages(prev => [
                ...prev.filter(m => m.role !== "via-temp"),
                { role: "via-temp", content: fullOutput.slice(0, i) }
              ]);
              i++;
            } else {
              clearInterval(interval);
              setMessages(prev => [
                ...prev.filter(m => m.role !== "via-temp"),
                { role: "via", content: fullOutput }
              ]);
              setGeneratedFile({ name: "generatedCode.js", content: fullOutput });
            }
          }, 20);

        } catch (err) {
          setMessages(prev => [...prev, { role: "via", content: "// Error generating code" }]);
          console.error(err);
        } finally {
          setLoading(false);
        }
      };

      const downloadFile = () => {
        if (!generatedFile) return;
        const blob = new Blob([generatedFile.content], { type: "text/plain" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = generatedFile.name;
        link.click();
      };

      return (
        <div>
          <div ref={terminalRef}>
            {messages.map((msg, i) => (
              <div key={i} className={msg.role.startsWith("via") ? "via" : "user"}>
                <strong>{msg.role.startsWith("via") ? "Via" : "You"}:</strong> {msg.content}
              </div>
            ))}
            {loading && <div className="via">Via is typing...</div>}
          </div>
          {generatedFile && (
            <button className="download-btn" onClick={downloadFile}>
              Download {generatedFile.name}
            </button>
          )}
        </div>
      );
    }

    ReactDOM.render(<Vida />, document.getElementById("terminal"));

    // Handle input
    const input = document.getElementById("prompt");
    const button = document.getElementById("send");
    button.onclick = () => {
      const val = input.value.trim();
      if (!val) return;
      const event = new Event('sendPromptEvent');
      event.value = val;
      window.dispatchEvent(event);
      input.value = "";
    };

    window.addEventListener('sendPromptEvent', (e) => {
      const vidaComponent = document.getElementById("terminal")._reactRootContainer._internalRoot.current.child.stateNode;
      if (vidaComponent) vidaComponent.sendPrompt(e.value);
    });
  </script>
</body>
</html>